<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Web Chat | Oskar Codes</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  
  <body>
    <main>
      <header>
        <div onclick="changeUser();" class="user"></div>
        <h1 onclick="changeRoom();">Chat</h1>
      </header>

      <div class="chat" style="overflow-y: scroll; overflow-wrap: break-word;">
        
      </div>

      <form onsubmit="send();" onkeypress="return event.keyCode!=13">
        <!--<input type="file" id="file"></input>-->
        <input maxlength="200" id="message" type="text" placeholder="Say something nice" />
        <button type="button" onclick="send();">Send</button>
      </form>
    </main>
    
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-database.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->

    <script>
      /*** SETUP CURRENT ROOM ***/
      var room = getAllUrlParams().room;
      var title = document.getElementsByTagName("h1")[0];
      if (room == undefined) {
        room = "";
        title.innerHTML = "Chat (Global)";
      } else if (room == true) {
        window.location.href = "https://oskar-codes.github.io/web-chat";
      } else {
        title.innerHTML = "Chat ("+ decodeURIComponent(room).replace(/</g, "&lt;").replace(/>/g, "&gt;") +")";
        window.document.title = decodeURIComponent(room).replace(/</g, "&lt;").replace(/>/g, "&gt;") +" | Oskar Codes";
      }
      
      /*** HANDLE ROOM CHANGE ***/
      function changeRoom() {
        var result = prompt("Enter a room id. The room will be created if it doesn't exist. An empty room id brings you back to the global room.", decodeURIComponent(room));
        if (result != null) {
          result = result.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          result = result.substring(0, 20);
          if (isNullOrEmpty(result)) {
            window.location.href = "https://oskar-codes.github.io/web-chat";
          } else {
            window.location.href = "https://oskar-codes.github.io/web-chat?room=" + result;
          }
        }
      }
      
      /*** HANDLE NOTIFICATIONS PERMISSION ***/
      var displayNotifications = false;
      if ('Notification' in window) {
        window.setTimeout(function() {
          displayNotifications = true;
        }, 2000) 
        Notification.requestPermission().then(function(result) {
          console.log("Notifications access status: "+result);
        });
      }
      
      /*** INITIALIZE USERNAME ***/
      var user = localStorage.getItem("user");
      var userIp = "";
      var file = "none";
      if (!user) {
        user = prompt("Choose a username");
        if (isNullOrEmpty(user)) {
          user = "Guest"
        }
        user = user.substring(0, 35);
        user = user.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        localStorage.setItem("user", user);
      }
      document.getElementsByClassName("user")[0].innerHTML = user;
      
      /*** CHANGE USERNAME ***/
      function changeUser() {
        var newUser = prompt("Choose a username", user);
        if (newUser != null) {
          if (isNullOrEmpty(newUser)) {
            newUser = "Guest"
          }
          newUser = newUser.substring(0, 35);
          newUser = newUser.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          user = newUser;
          localStorage.setItem("user", user);
          document.getElementsByClassName("user")[0].innerHTML = user;
        }
      }
      
      /*** FIREBASE CONFIGURATION ***/
      var firebaseConfig = {
        apiKey: "AIzaSyA2OMVp6D5IksJo8EJgWsyI0UV9bm08c8A",
        authDomain: "github-web-chat.firebaseapp.com",
        databaseURL: "https://github-web-chat.firebaseio.com",
        projectId: "github-web-chat",
        storageBucket: "github-web-chat.appspot.com",
        messagingSenderId: "165990792894",
        appId: "1:165990792894:web:8f2ec6b1984e71e24ca8ef"
      };
      firebase.initializeApp(firebaseConfig);
      
      /*** FORMAT MESSAGE OBJECT AND PUSH IT TO THE FIREBASE DATABASE ***/
      function saveToFirebase(msg, usr) {
        var object = {
          user: usr,
          message: msg,
          attachment: file,
          time: getDateTime(),
          ip: userIp
        };

        firebase.database().ref('messages' + room).push().set(object)
        .then(function(snapshot) {
          console.log("Message successfully sent!");
        }, function(e) {
          console.log(e);
          var chat = document.getElementsByClassName("chat")[0];
          chat.innerHTML += "<p style='color: red;'><b>Your message failed to send:</b><br>"+ e +"</p><hr style='border-color: #ddd; border-style: solid;'>";
          chat.scrollBy(0, 100000);
        });
      }
      
      /*** LISTEN FOR NEW MESSAGES FROM THE FIREBASE DATABASE AND FORMAT THEM ***/
      var messagesRef  = firebase.database().ref('messages' + room);
      messagesRef.on('child_added', (snapshot) => {
        var chat = document.getElementsByClassName("chat")[0];
        var usr = snapshot.val().user;
        var msg = snapshot.val().message;
        var time = snapshot.val().time;
        chat.innerHTML += "<p><strong>" + usr + "</strong> ("+ time +"):</p><p style='margin-left: 7px;'>" + msg.replace(/</g, "&lt;").replace(/>/g, "&gt;") + "</p><hr style='border-color: #ddd; border-style: solid;'>";
        chat.scrollBy(0, 100000);
        
        /*** DISPLAY NOTIFICATION ***/
        if (displayNotifications && usr != user) {
          var text = usr + ": " + msg;
          var notification = new Notification('Web Chat', {body: text});
        }
      });
      
      /*** HANDLE MESSAGE BEFORE SENDING ***/
      function send() {
        var msgBox = document.getElementById("message");
        var msg = msgBox.value;
        var chat = document.getElementsByClassName("chat")[0];
        if (!isNullOrEmpty(msg)) {
          msgBox.value = "";
          chat.scrollBy(0, 100000);
          msg = msg.substring(0, 200);
          saveToFirebase(msg, user);
        }
      }
      
      /*** ALLOW USE OF "ENTER" KEY TO SEND MESSAGE ***/
      document.getElementById("message").onkeyup = function(e) {
        if (e.key === "Enter") {
          send();
        }
      }
      
      /*** HELPER FUNCTIONS ***/
      function isNullOrEmpty(str) {
        return !str || !str.trim();
      }
      
      function getIp(json) {
        userIp = json.ip;
      }
      
      function getDateTime() {
        var now     = new Date(); 
        var year    = now.getFullYear();
        var month   = now.getMonth()+1; 
        var day     = now.getDate();
        var hour    = now.getHours();
        var minute  = now.getMinutes();
        var second  = now.getSeconds(); 
        if(month.toString().length == 1) {
             month = '0'+month;
        }
        if(day.toString().length == 1) {
             day = '0'+day;
        }   
        if(hour.toString().length == 1) {
             hour = '0'+hour;
        }
        if(minute.toString().length == 1) {
             minute = '0'+minute;
        }
        if(second.toString().length == 1) {
             second = '0'+second;
        }   
        var dateTime = day+'/'+month+'/'+year+' '+hour+':'+minute;   
         return dateTime;
      }
      
      /*function toDataURL(src, callback) {
        var request = new XMLHttpRequest();
        request.onload = function() {
          var fileReader = new FileReader();
          fileReader.onloadend = function() {
            callback(fileReader.result);
          }
          fileReader.readAsDataURL(request.response);
        }

        request.responseType = "blob";
        request.open("GET", src, true);
        request.send();
      }
      
      document.getElementById("file").onchange = function(e) {
        var path = URL.createObjectURL(e.target.files[0]);
        toDataURL(path, function(dataURL) {
          file = dataURL;
        }
      }*/
      
      function getAllUrlParams(url) {
        var queryString = url ? url.split('?')[1] : window.location.search.slice(1);
        var obj = {};
        if (queryString) {
          queryString = queryString.split('#')[0];
          var arr = queryString.split('&');
          for (var i = 0; i < arr.length; i++) {
            var a = arr[i].split('=');
            var paramName = a[0];
            var paramValue = typeof (a[1]) === 'undefined' ? true : a[1];
            paramName = paramName.toLowerCase();
            if (typeof paramValue === 'string') paramValue = paramValue.toLowerCase();
            if (paramName.match(/\[(\d+)?\]$/)) {
              var key = paramName.replace(/\[(\d+)?\]/, '');
              if (!obj[key]) obj[key] = [];
              if (paramName.match(/\[\d+\]$/)) {
                var index = /\[(\d+)\]/.exec(paramName)[1];
                obj[key][index] = paramValue;
              } else {
                obj[key].push(paramValue);
              }
            } else {
              if (!obj[paramName]) {
                obj[paramName] = paramValue;
              } else if (obj[paramName] && typeof obj[paramName] === 'string'){
                obj[paramName] = [obj[paramName]];
                obj[paramName].push(paramValue);
              } else {
                obj[paramName].push(paramValue);
              }
            }
          }
        }
        return obj;
      }
    </script>
    <script src="https://api.ipify.org?format=jsonp&callback=getIp"></script>
  </body>
</html>
