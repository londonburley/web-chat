<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Chat</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  
  <body>
    <main>
      <header>
        <div onclick="changeUser();" class="user"></div>
        <h1>Chat</h1>
      </header>

      <div class="chat" style="overflow-y: scroll; overflow-x: hidden;">
        
      </div>

      <form onsubmit="send();" onkeypress="return event.keyCode!=13">
        <input id="message" type="text" placeholder="Say something nice" />
        <button type="button" onclick="send();">Send</button>
      </form>
    </main>
    
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-database.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyA2OMVp6D5IksJo8EJgWsyI0UV9bm08c8A",
        authDomain: "github-web-chat.firebaseapp.com",
        databaseURL: "https://github-web-chat.firebaseio.com",
        projectId: "github-web-chat",
        storageBucket: "github-web-chat.appspot.com",
        messagingSenderId: "165990792894",
        appId: "1:165990792894:web:8f2ec6b1984e71e24ca8ef"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      
      function saveToFirebase(msg, usr) {
        var object = {
          user: usr,
          message: msg,
          time: getDateTime(), 
          html: "<p><strong>" + usr + "</strong> ("+ getDateTime() +"):</p><p style='margin-left: 7px;'>" + msg.replace(/</g, "&lt;").replace(/>/g, "&gt;") + "</p><hr>"
        };

        firebase.database().ref('messages').push().set(object)
            .then(function(snapshot) {
                console.log("Message successfully sent!");
            }, function(error) {
                console.log('An error occured: ' + error);
            });
      }
      
      var messagesRef  = firebase.database().ref('messages');
      messagesRef.on('child_added', (snapshot) => {
        console.log('message was added: ' + snapshot.val().html);
        var chat = document.getElementsByClassName("chat")[0];
        chat.innerHTML += snapshot.val().html;
      });
    </script>
    
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script>
      var user = localStorage.getItem("user");
      if (!user) {
        user = prompt("Choose a username");
        if (isNullOrEmpty(user)) {
          user = "Guest"
        }
        user = user.substring(0, 10);
        user = user.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        localStorage.setItem("user", user);
      }
      document.getElementsByClassName("user")[0].innerHTML = user;
      
      function changeUser() {
        user = prompt("Choose a username");
        if (isNullOrEmpty(user)) {
          user = "Guest"
        }
        user = user.substring(0, 10);
        user = user.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        localStorage.setItem("user", user);
        document.getElementsByClassName("user")[0].innerHTML = user;
      }
      
      function send() {
        var msgBox = document.getElementById("message");
        var msg = msgBox.value;
        var chat = document.getElementsByClassName("chat")[0];
        if (!isNullOrEmpty(msg)) {
          msgBox.value = "";
          chat.scrollTop = chat.scrollHeight;
          saveToFirebase(msg, user);
        }
      }
      
      document.getElementById("message").onkeyup = function(e) {
        if (e.key === "Enter") {
          send();
        }
      }
      
      function isNullOrEmpty(str) {
        return !str || !str.trim();
      }
      
      function getDateTime() {
        var now     = new Date(); 
        var year    = now.getFullYear();
        var month   = now.getMonth()+1; 
        var day     = now.getDate();
        var hour    = now.getHours();
        var minute  = now.getMinutes();
        var second  = now.getSeconds(); 
        if(month.toString().length == 1) {
             month = '0'+month;
        }
        if(day.toString().length == 1) {
             day = '0'+day;
        }   
        if(hour.toString().length == 1) {
             hour = '0'+hour;
        }
        if(minute.toString().length == 1) {
             minute = '0'+minute;
        }
        if(second.toString().length == 1) {
             second = '0'+second;
        }   
        var dateTime = day+'/'+month+'/'+year+' '+hour+'h'+minute;   
         return dateTime;
      }
    </script>
  </body>
</html>
